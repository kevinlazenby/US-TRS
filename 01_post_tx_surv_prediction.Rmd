---
title: "01_post_tx_surv_prediction"
author: "Kevin Lazenby"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidymodels)
library(here)
library(haven)
library(sas7bdat)
library(ggh4x)
library(reticulate)
library(lubridate)
library(splines)
library(Hmisc)
library(knitr)
library(ggrcs)
library(cowplot)
library(lemon)
library(pROC)
library(gtsummary)
library(boot)
library(consort)
library(grid)
library(gt)
library(flextable)
library(labelled)
library(dtplyr)
library(rms)
library(data.table)
library(coxme)
library(zoo)
library(riskRegression)
library(adjustedCurves)
library(cvwrapr)
library(devtools)
library(survminer)
# install_github('junkka/ehahelper')

tidymodels_prefer()
set.seed(2023)

here::i_am("01_post_tx_surv_prediction.Rmd")

```

## Function definitions used in later analysis

```{r function definitions}

custom_theme <- function() {
  theme_light() %+replace%
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    # axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    # axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    # axis.title.y = element_text(size = 15, margin = margin(r=5)),
    # axis.text.y = element_text(size = 14, margin = margin(r=5)),
    # legend.title = element_text(size = 15),
    # legend.text = element_text(size = 15),
    # strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank()
    )
}

# custom_theme <- function() {
#   theme_light() %+replace%
#     theme(
#       plot.title=element_text(hjust=0.5, margin = margin(0,0,10,0))
#     )
# }

```

## Load in data

```{r}

curr_data_release <- "pubsaf2403"
time_of_tx_file_prefix <- "at_tx_dataset_"
end_cohort_date <- "3_1_22"
RData_suffix <- ".RData"

raw_data_filename <- paste0(curr_data_release, "_raw_heart_data.RData")

load(here(curr_data_release, raw_data_filename))

rm(stat_just_hr1a, stat_just_hr1b, status_just_episode, thor_support_device,
   table_descriptions, column_descriptions, just_form_hr,
   just_form_hr_data_link, just_form_hr_stat1, just_form_hr_stat2,
   just_form_hr_stat3, just_form_hr_stat4, risk_strat_data_hr,
   stathist_thor, cand_thor)

load(here(curr_data_release, paste0(time_of_tx_file_prefix,
                                    end_cohort_date,
                                    RData_suffix)))

final_list_at_tx <- final_list_at_tx |> 
  mutate(incomplete_fu = if_else(surv_status_365 == 0 & surv_time_365 < 365, 1, 0))
```

# Filtering TX_HR for reference

```{r}
tx_hr_raw <- tx_hr

tx_hr <- tx_hr |> 
  
  # Remove recipients transplanted before policy change
  filter(REC_TX_DT >= mdy("10-18-2018"))

nrow(tx_hr)

tx_hr <- tx_hr |> 
  
  # Remove recipients transplanted on or after March 1, 2022
  filter(REC_TX_DT < mdy("3-1-2022"))

nrow(tx_hr)

tx_hr <- tx_hr |> 
  
  # Remove recipients listed prior to policy change
  filter(CAN_LISTING_DT >= mdy("10-18-2018"))

nrow(tx_hr)

tx_hr <- tx_hr |> 
  
  # Remove recipients who were < 18 yrs old at listing
  filter((CAN_AGE_IN_MONTHS_AT_LISTING / 12) >= 18)

nrow(tx_hr)

tx_hr <- tx_hr |>
  
  # Remove recipients with an initial status or last status from old policy
  filter(!(CAN_INIT_STAT %in% c(2010, 2020, 2030)))  |>  
  filter(!(CAN_LAST_STAT %in% c(2010, 2020, 2030)))

nrow(tx_hr)

tx_hr <- tx_hr |> 
  
  mutate(center_id = REC_CTR_CD) |> 
  
  # Remove candidates with missing center ID
  filter(!is.na(center_id))

nrow(tx_hr)

# Remove recipients with obvious height and weight data entry errors
data_error_PX_IDs <- tx_hr |> 
  filter(REC_BMI > 50 | REC_BMI < 10) |> 
  pull(PX_ID)

tx_hr <- tx_hr |> 
  filter(!(PX_ID %in% data_error_PX_IDs))

nrow(tx_hr)

rec_PX_IDs <- tx_hr |> pull(PX_ID)

final_list_at_tx <- final_list_at_tx |> left_join(
  tx_hr |> select(CAN_ETHNICITY_SRTR, CAN_RACE_SRTR, PX_ID), by = "PX_ID") |> 
  mutate(ethnicity = if_else(CAN_ETHNICITY_SRTR == "LATINO", 1, 0)) |> 
  mutate(ethnicity = factor(ethnicity, levels = c(0, 1),
                           labels = c("Not Hispanic or Latino",
                                      "Hispanic or Latino"))) |> 
  mutate(race = case_when(
    CAN_RACE_SRTR == "WHITE" ~ 1,
    CAN_RACE_SRTR == "BLACK" ~ 2,
    CAN_RACE_SRTR == "ASIAN" ~ 3,
    CAN_RACE_SRTR == "NATIVE" ~ 4,
    CAN_RACE_SRTR == "PACIFIC" ~ 5,
    CAN_RACE_SRTR == "MULTI" ~ 6)) |> 
  
  mutate(race = factor(race,
                       levels = c(1, 2, 3, 4, 5, 6),
                       labels = c("White",
                                  "Black",
                                  "Asian",
                                  "Native American",
                                  "Pacific Islander",
                                  "Multiracial")))

```

## Data Splitting
# Input data is created by heart_data_pipeline.Rmd and 00_data_preparation.Rmd

```{r splitting data}

set.seed(2023)

# Split by center
data_split_by_center <- group_initial_split(final_list_at_tx, 
                                            prop = 0.70,
                                            group = center_id)

data_train_by_center <- training(data_split_by_center)
data_test_by_center  <- testing(data_split_by_center)

training_centers <- data_train_by_center |> pull(center_id) |> unique()
testing_centers <- data_test_by_center |> pull(center_id) |> unique()

final_list_at_tx <- final_list_at_tx |> 
  mutate(training_set = if_else(center_id %in% training_centers, 1, 0))

# Random split
data_split_random <- initial_split(final_list_at_tx,
                                   prop = 0.70)

data_train_random <- training(data_split_random)
data_test_random <- testing(data_split_random)

# Temporal split
final_list_at_tx <- final_list_at_tx |> arrange(tx_date)

data_split_temporal <- initial_time_split(final_list_at_tx, prop = 0.70)
data_train_temporal <- training(data_split_temporal)
data_test_temporal  <- testing(data_split_temporal)

training_start_date <- data_train_temporal |> pull(tx_date) |> min()
training_end_date <- data_train_temporal |> pull(tx_date) |> max()
testing_start_date <- data_test_temporal |> pull(tx_date) |> min()
testing_end_date <- data_test_temporal |> pull(tx_date) |> max()

```

# Exploratory univariate regression with data at transplant in training set

```{r}

run_exploratory_analysis <- FALSE

if (run_exploratory_analysis == TRUE) {
  
  uv_reg_table <- data_train_temporal |>
    select(surv_status_365, surv_time_365,
           curr_list_status_factor,
           waitlist_time, 
           PCWP, SVO2, cardiac_index, resting_HR, 
           systolicBP, diastolicBP, PASP, PADP, MPAP, dpg, api, 
           cpo, papi, central_venous_pressure,
           arterial_lactate,
           AST,
           eGFR_10, 
           log_eGFR,
           creatinine,
           BUN_Cr_ratio,
           bilirubin,
           log_bilirubin, albumin, 
           sodium,
           BNP,
           BUN_10,
           log_BUN,
           INR,
           LDH, 
           HemoHemoglobin,
           IV_inotropes_ever,
           IABP_ever,
           ECMO, ECMO_ever,
           durable_LVAD, 
           durable_LVAD_ever,
           short_MCS_ever,
           diagnosis_factor,
           diagnosis_limited_factor,
           tx_indication_factor,
           congenital_or_valvular_factor,
           ischemic,
           congenital,
           retransplant,
           diabetes, dialysis,
           cand_sex_factor, 
           female_don_male_rec, 
           mech_vent, 
           infection,
           rec_age_10, transfusion,
           IMPACT_score, rec_height_10, 
           rec_weight_10, 
           rec_BMI,
           hx_card_surg, hx_card_surg_limited_factor,
           prior_CABG,
           can_cvd, 
           can_malig, 
           rec_cmv_stat, rec_hiv_stat, rec_ebv_stat,
           rec_hbv_ab, 
           rec_hbv_sa, rec_hcv_stat, rec_abo,
           rec_func_stat_under30,
           donor_age_over_55,
           donor_COD_factor,
           donor_death_mech_factor,
           don_height_10,
           don_weight,
           PHM_ratio,
           donor_age_10, 
           donor_sex, donor_creatinine, donor_diabetes, donor_HTN, donor_smoking,
           donor_cocaine_use, donor_CMV, donor_cancer_hist
    ) |> 
    tbl_uvregression(
      method = coxph,
      y = Surv(surv_time_365, surv_status_365),
      # method.args = list(family = binomial),
      exponentiate = TRUE,
      pvalue_fun = ~style_pvalue(.x, digits = 2)) |>
    # add_global_p() |>
    # add_nevent() |>
    add_q() |>         # adjusts global p-values for multiple testing
    bold_p() |>
    bold_p(t = 0.05, q = TRUE) |>
    bold_labels()
  
  uv_reg_table |> as_flex_table()
  
  uv_reg_table |> as_gt() |> gtsave(filename = "us_trs_uv_reg.rtf")
}

```

# US-TRS: Cox mixed effects model with center random effects

```{r}

us_trs <- coxph(Surv(surv_time_365, surv_status_365) ~
                   
                   # Demographics and medical history
                   rec_age_10 +
                   congenital +
                   diabetes +
                   
                   # Treatments
                   mech_vent +
                   durable_LVAD +
                  
                   # Labs
                   eGFR_10 +
                   log_bilirubin +
                   albumin +
                   
                   # Donor variables
                   donor_age_over_55 +
                   donor_sex +
                   PHM_ratio_undersized +
                   
                   # Transplant center random effects
                   frailty(center_id),
                 
                 data = data_train_temporal,
                x = TRUE)

summary(us_trs)

us_trs |> tbl_regression(exponentiate = TRUE) |>
  as_gt() |>
  gtsave(filename = "us_trs_model_coef.rtf")

```

# Additional models

```{r}

french_trs <- coxph(Surv(surv_time_365, surv_status_365) ~
                   
                   # Demographics and medical history
                   age_over_50 +
                   congenital_or_valvular +
                   diabetes +
                   hx_card_surg +
                     
                   # Treatments
                   mech_vent +   
                   
                   # Labs
                   log_eGFR +
                   log_bilirubin +
                   
                   # Donor variables
                   donor_age_over_55 +
                   donor_sex +
                   
                   # Transplant center random effects
                   frailty(center_id),
                 
                 data = data_train_temporal,
                x = TRUE)

# summary(french_trs)

french_trs |> tbl_regression(exponentiate = TRUE) |>
  as_gt() |>
  gtsave(filename = "french_trs_model_coef.rtf")

impact_cox <- coxph(Surv(surv_time_365, surv_status_365) ~
                      
                      age_over_60_factor +
                      bilirubin_binned_factor +
                      eGFR_binned_factor +
                      dialysis_factor +
                      cand_sex_factor +
                      IMPACT_diagnosis_factor +
                      infection_factor + 
                      IABP_factor +
                      mech_vent_factor +
                      race_ethnicity_factor +
                      IMPACT_VAD_factor +
                      temp_circ_supp_factor,
                    
                    data = data_train_temporal)

impact_cox |> tbl_regression(exponentiate = TRUE) |>
  as_gt() |>
  gtsave(filename = "impact_model_coef.rtf")

# summary(impact_cox)

impact_score_cox <- coxph(Surv(surv_time_365, surv_status_365) ~
                      
                      IMPACT_score,
                    
                    data = data_train_temporal)

impact_score_cox |> tbl_regression(exponentiate = TRUE) |>
  as_gt() |>
  gtsave(filename = "impact_score_model_coef.rtf")

# summary(impact_score_cox)

waitlist_status_cox <- coxph(Surv(surv_time_365, surv_status_365) ~
                      
                      curr_list_status_factor,
                    
                    data = data_train_temporal)

waitlist_status_cox |> tbl_regression(exponentiate = TRUE) |>
  as_gt() |>
  gtsave(filename = "waitlist_status_model_coef.rtf")

# summary(waitlist_status_cox)

us_trs_coxme <- coxme(Surv(surv_time_365, surv_status_365) ~
                   
                   # Demographics and medical history
                   rec_age_10 +
                   congenital +
                   diabetes +
                   # prior_CABG +
                   
                   # Treatments
                   mech_vent +
                   durable_LVAD +
                  
                   # Labs
                   eGFR_10 +
                   log_bilirubin +
                   albumin +
                   
                   # Donor variables
                   donor_age_over_55 +
                   donor_sex +
                   PHM_ratio_undersized +
                   
                   # Transplant center random effects
                   (1 | center_id),
                 
                 data = data_train_temporal,
                x = TRUE)

us_trs_with_card_surg <- coxph(Surv(surv_time_365, surv_status_365) ~
                   
                   # Demographics and medical history
                   rec_age_10 +
                   congenital +
                   diabetes +
                   hx_card_surg +
                   
                   # Treatments
                   mech_vent +
                   durable_LVAD +
                  
                   # Labs
                   eGFR_10 +
                   log_bilirubin +
                   albumin +
                   
                   # Donor variables
                   donor_age_over_55 +
                   donor_sex +
                   PHM_ratio_undersized +
                   
                   # Transplant center random effects
                   frailty(center_id),
                 
                 data = data_train_temporal,
                x = TRUE)

us_trs_with_card_surg |> tbl_regression(exponentiate = TRUE) |>
  as_gt() |>
  gtsave(filename = "us_trs_with_card_surg_model_coef.rtf")

```

# Bootstrap confidence intervals for c-index

```{r}

do_bootstrapping <- TRUE

if (do_bootstrapping == TRUE) {
  
  # US-TRS
  # calculating bootstrap confidence intervals
  FUN_us_trs <- function(dataset, i) {
    
    us_trs.boot <- coxph(Surv(surv_time_365, surv_status_365) ~
                     
                     # Demographics and medical history
                     rec_age_10 +
                     congenital +
                     diabetes +
                     
                     # Treatments
                     mech_vent +
                     durable_LVAD +
                     
                     # Labs
                     eGFR_10 +
                     log_bilirubin +
                     albumin +
                     
                     # Donor variables
                     donor_age_over_55 +
                     donor_sex +
                     PHM_ratio_undersized +
                     
                     # Transplant center random effects
                     frailty(center_id),
                   
                   data = dataset[i,])
    
    concordance(us_trs.boot, newdata = data_test_temporal, timewt="n/G2")$concordance
    
  }
  
  us_trs_data_train_temporal_only_predictors <- data_train_temporal |> 
    select(surv_time_365, surv_status_365, rec_age_10, congenital, diabetes,
           mech_vent, durable_LVAD, eGFR_10,
           log_bilirubin, albumin,
           donor_age_over_55, donor_sex, PHM_ratio_undersized, center_id)
  
  us_trs.boot.result <- boot(us_trs_data_train_temporal_only_predictors, FUN_us_trs, R=1000)
  
  summary(us_trs.boot.result)
  
  # the percentile confidence intervals
  boot.ci(us_trs.boot.result, type=c("norm", "basic", "perc"))
  
  ggplot(mapping = aes(us_trs.boot.result$t)) + geom_histogram()
  
  # French-TRS
  # calculating bootstrap confidence intervals
  FUN_french_trs <- function(dataset, i) {
    
    french_trs.boot <- coxph(Surv(surv_time_365, surv_status_365) ~
                     
                   # Demographics and medical history
                   age_over_50 +
                   congenital_or_valvular +
                   diabetes +
                   hx_card_surg +
                     
                   # Treatments
                   mech_vent +   
                   
                   # Labs
                   log_eGFR +
                   log_bilirubin +
                   
                   # Donor variables
                   donor_age_over_55 +
                   donor_sex +
                   
                   # Transplant center random effects
                   frailty(center_id),
                   
                   data = dataset[i,])
    
    concordance(french_trs.boot, newdata = data_test_temporal, timewt="n/G2")$concordance
    
  }
  
  french_trs_data_train_temporal_only_predictors <- data_train_temporal |> 
    select(surv_time_365, surv_status_365, age_over_50, congenital_or_valvular, 
           diabetes, hx_card_surg,
           mech_vent, log_eGFR,
           log_bilirubin,
           donor_age_over_55, donor_sex, center_id)
  
  french_trs.boot.result <- boot(french_trs_data_train_temporal_only_predictors, FUN_french_trs, R=1000)
  
  summary(french_trs.boot.result)
  
  # the percentile confidence intervals
  boot.ci(french_trs.boot.result, type=c("norm", "basic", "perc"))
  
  ggplot(mapping = aes(french_trs.boot.result$t)) + geom_histogram()
  
  # IMPACT
  # calculating bootstrap confidence intervals
  FUN_impact <- function(dataset, i) {
    
    impact.boot <- coxph(Surv(surv_time_365, surv_status_365) ~
                     
                      age_over_60_factor +
                      bilirubin_binned_factor +
                      eGFR_binned_factor +
                      dialysis_factor +
                      cand_sex_factor +
                      IMPACT_diagnosis_factor +
                      infection_factor + 
                      IABP_factor +
                      mech_vent_factor +
                      race_ethnicity_factor +
                      IMPACT_VAD_factor +
                      temp_circ_supp_factor,
                   
                   data = dataset[i,])
    
    concordance(impact.boot, newdata = data_test_temporal, timewt="n/G2")$concordance
    
  }
  
  impact_data_train_temporal_only_predictors <- data_train_temporal |> 
    select(surv_time_365, surv_status_365, 
                      age_over_60_factor,
                      bilirubin_binned_factor,
                      eGFR_binned_factor,
                      dialysis_factor,
                      cand_sex_factor,
                      IMPACT_diagnosis_factor,
                      infection_factor, 
                      IABP_factor,
                      mech_vent_factor,
                      race_ethnicity_factor,
                      IMPACT_VAD_factor,
                      temp_circ_supp_factor)
  
  impact.boot.result <- boot(impact_data_train_temporal_only_predictors, FUN_impact, R=1000)
  
  summary(impact.boot.result)
  
  # the percentile confidence intervals
  boot.ci(impact.boot.result, type=c("norm", "basic", "perc"))
  
  ggplot(mapping = aes(impact.boot.result$t)) + geom_histogram()
  
  # IMPACT score
  # calculating bootstrap confidence intervals
  FUN_impact_score <- function(dataset, i) {
    
    impact_score.boot <- coxph(Surv(surv_time_365, surv_status_365) ~
                     
                      IMPACT_score,
                   
                   data = dataset[i,])
    
    concordance(impact_score.boot, newdata = data_test_temporal, timewt="n/G2")$concordance
    
  }
  
  impact_score_data_train_temporal_only_predictors <- data_train_temporal |> 
    select(surv_time_365, surv_status_365, IMPACT_score)
  
  impact_score.boot.result <- boot(impact_score_data_train_temporal_only_predictors, FUN_impact_score, R=1000)
  
  summary(impact_score.boot.result)
  
  # the percentile confidence intervals
  boot.ci(impact_score.boot.result, type=c("norm", "basic", "perc"))
  
  ggplot(mapping = aes(impact_score.boot.result$t)) + geom_histogram()
  
  # Waitlist status at transplant
  # calculating bootstrap confidence intervals
  FUN_waitlist <- function(dataset, i) {
    
    waitlist.boot <- coxph(Surv(surv_time_365, surv_status_365) ~
                     
                      curr_list_status_factor,
                   
                   data = dataset[i,])
    
    concordance(waitlist.boot, newdata = data_test_temporal, timewt="n/G2")$concordance
    
  }
  
  waitlist_data_train_temporal_only_predictors <- data_train_temporal |> 
    select(surv_time_365, surv_status_365, curr_list_status_factor)
  
  waitlist.boot.result <- boot(waitlist_data_train_temporal_only_predictors, FUN_waitlist, R=1000)
  
  summary(waitlist.boot.result)
  
  # the percentile confidence intervals
  boot.ci(waitlist.boot.result, type=c("norm", "basic", "perc"))
  
  ggplot(mapping = aes(waitlist.boot.result$t)) + geom_histogram() 
}
```

# Evaluate models in the test set

```{r}

# US TRS in test set
concordance(us_trs, newdata = data_test_temporal, timewt="n/G2")

# Select only Status 1 recipients in test set
status_1_only <- data_test_temporal |> 
  filter(curr_list_status_factor == "Status 1")

# US TRS in test set (only Status 1 candidates)
concordance(us_trs, newdata = status_1_only, timewt="n/G2")

# US-TRS
# calculating bootstrap confidence intervals
FUN_us_trs_status_1 <- function(dataset, i) {
  
  us_trs_status_1.boot <- coxph(Surv(surv_time_365, surv_status_365) ~
                         
                         # Demographics and medical history
                         rec_age_10 +
                         congenital +
                         diabetes +
                         
                         # Treatments
                         mech_vent +
                         durable_LVAD +
                         
                         # Labs
                         eGFR_10 +
                         log_bilirubin +
                         albumin +
                         
                         # Donor variables
                         donor_age_over_55 +
                         donor_sex +
                         PHM_ratio_undersized +
                         
                         # Transplant center random effects
                         frailty(center_id),
                       
                       data = dataset[i,])
  
  concordance(us_trs_status_1.boot, newdata = status_1_only, timewt="n/G2")$concordance
  
}

us_trs_status_1_data_train_temporal_only_predictors <- status_1_only |> 
  select(surv_time_365, surv_status_365, rec_age_10, congenital, diabetes,
         mech_vent, durable_LVAD, eGFR_10,
         log_bilirubin, albumin,
         donor_age_over_55, donor_sex, PHM_ratio_undersized, center_id)

us_trs_status_1.boot.result <- boot(us_trs_status_1_data_train_temporal_only_predictors, FUN_us_trs_status_1, R=1000)

summary(us_trs_status_1.boot.result)

# the percentile confidence intervals
boot.ci(us_trs_status_1.boot.result, type=c("norm", "basic", "perc"))

ggplot(mapping = aes(us_trs_status_1.boot.result$t)) + geom_histogram()

# Refitted IMPACT model in test set
concordance(impact_cox, newdata = data_test_temporal, timewt="n/G2")

# French TRS in test set
concordance(french_trs, newdata = data_test_temporal, timewt="n/G2")

# Refitted IMPACT score only model in test set
concordance(impact_score_cox, newdata = data_test_temporal, timewt="n/G2")

# Waitlist status model in test set
concordance(waitlist_status_cox, newdata = data_test_temporal, timewt="n/G2")

# US TRS coxme model in test set
predicted_values_coxme <- ehahelper::predict_coxme(us_trs_coxme,
                                             newdata = data_test_temporal,
                                             type = "lp",
                                             strata_ref = FALSE)

getCindex(predicted_values_coxme, Surv(data_test_temporal$surv_time_365,
                               data_test_temporal$surv_status_365))

# US-TRS with French TRS predictors
concordance(us_trs_with_card_surg, newdata = data_test_temporal, timewt="n/G2")

```

# RMST in test set and calculate US TRS 10-point score

```{r}

us_trs_predicted <- predictCox(us_trs, times = seq(1, 365, 1),
                               newdata = data_test_temporal,
                               keep.times = TRUE)

survival_estimates <- us_trs_predicted$survival |> as.data.frame()

init_surv_probs <- data.frame(time_0 = rep_len(1, length(data_test_temporal$PX_ID)))

survival_estimates <- bind_cols(init_surv_probs, survival_estimates) |> as.matrix()

data_test_temporal$rmst_test <- rep_len(0, length(data_test_temporal$PX_ID))

for (i in seq(1:length(data_test_temporal$PX_ID))) {
  temp_var <- integrate(function(x) {survival_estimates[i, x]}, 
            lower = 1,
            upper = 366,
            subdivisions = 365)
  
  data_test_temporal$rmst_test[i] <- temp_var$value
}

# Histogram of RMST
data_test_temporal |> ggplot(mapping = aes(x = rmst_test)) +
  geom_histogram(bins = 50, center = 0, color = "black", fill = "gray") +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Restricted mean survival time (days)") +
  ylab("Number of recipients") +
  scale_x_continuous(breaks = c(90, 180, 270, 360))

# Compare to Riemann sums by hand
time_steps <- rep_len(1, 365)
rmst_calc_by_hand <- (survival_estimates * time_steps) |> rowSums()

data_test_temporal <- data_test_temporal %>%
  mutate(US_TRS_score = cut_interval(rmst_test, n = 10, labels= FALSE),
         
         US_TRS_percentile = cut_number(rmst_test, n = 10, labels = FALSE))

# Histogram of US TRS score
data_test_temporal |> ggplot(mapping = aes(x = US_TRS_score)) +
  geom_histogram(bins = 10, center = 0, color = "black", fill = "gray") +
  scale_x_continuous(n.breaks = 8) +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("US TRS Score") +
  ylab("Number of recipients")

```

# Figure 2: Combined US TRS and French TRS forest plot

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}

# Collecting US-TRS estimates and CIs
df_coefplot <- as.data.frame(summary(us_trs)$conf.int)[,c(1,3,4)]
df_coefplot$variable <- rownames(df_coefplot)
rownames(df_coefplot) <- NULL
colnames(df_coefplot) <- c('estimate', 'lower_CI', 'upper_CI', 'variable')
df_coefplot <- df_coefplot |> filter(variable != "frailty(center_id)")

df_coefplot$variable <- c('Recipient age', 'Indication: CHD/VHD', 
                          'Diabetes', 
                          'Mechanical ventilation', 'Durable LVAD',
                          'eGFR', 'Log bilirubin', 'Albumin',
                          'Donor age over 55', 'Female donor', 'Size mismatch')

df_coefplot[nrow(df_coefplot) + 1,] = c(NA, NA, NA, "History of cardiac surgery")

# Collecting French TRS estimates and CIs
df_coefplot_french <- as.data.frame(summary(french_trs)$conf.int)[,c(1,3,4)]
df_coefplot_french$variable <- rownames(df_coefplot_french)
rownames(df_coefplot_french) <- NULL
colnames(df_coefplot_french) <- c('estimate', 'lower_CI', 'upper_CI', 'variable')
df_coefplot_french <- df_coefplot_french |> filter(variable != "frailty(center_id)")

df_coefplot_french$variable <- c('Recipient age',
                                 'Indication: CHD/VHD', 
                                 'Diabetes', 
                                 'History of cardiac surgery',
                                 'Mechanical ventilation',
                                 'eGFR',
                                 'Log bilirubin',
                                 'Donor age over 55', 
                                 'Female donor')

df_coefplot_french[nrow(df_coefplot_french) + 1,] = c(NA, NA, NA, "Albumin")
df_coefplot_french[nrow(df_coefplot_french) + 1,] = c(NA, NA, NA, "Durable LVAD")
df_coefplot_french[nrow(df_coefplot_french) + 1,] = c(NA, NA, NA, "Size mismatch")

df_coefplot_french <- df_coefplot_french |> 
  mutate(model = "French")

df_coefplot <- df_coefplot |> 
  mutate(model = "US")

df_coefplot_combo <- df_coefplot |> rbind(df_coefplot_french)

df_coefplot_combo <- df_coefplot_combo |> 
  mutate(estimate = as.numeric(estimate),
         lower_CI = as.numeric(lower_CI),
         upper_CI = as.numeric(upper_CI))

forest_plot <- df_coefplot_combo %>%
  ggplot(aes(x=estimate, 
             y=factor(variable, 
                      levels = c('Size mismatch',
                                 'Durable LVAD',
                                 'Albumin',
                                 'Female donor', 
                                 'Donor age over 55',
                                 'Indication: CHD/VHD', 
                                 'Mechanical ventilation',
                                 'Diabetes',
                                 'eGFR', 
                                 'Log bilirubin',
                                 'Recipient age',
                                 'History of cardiac surgery')),
             color=model)) +
  geom_point(size = 3.25, position = position_dodge(width = 0.7)) +
  geom_errorbarh(aes(xmin = lower_CI, xmax = upper_CI), position = position_dodge(width = 0.7)) +
  geom_vline(xintercept = 1, lty = 2, color = '#880d1e', linewidth = 0.05) +
  xlab('Hazard Ratio (95% CI)') +
  xlim(0, 5) +
  scale_x_log10(n.breaks = 6) +
  # labs(caption = paste0("\u1D43", "Variable scaled by factor of 10")) +
  scale_y_discrete(labels=c('Size mismatch',
                            'Durable LVAD',
                            'Albumin',
                            'Female donor',
                            'Donor age over 55',
                            'Transplant indication',
                            'Mechanical ventilation',
                            'Diabetes',
                            'eGFR',
                            'Log bilirubin',
                            'Recipient age',
                            'History of cardiac surgery')) +
  scale_colour_manual(name='Model',
                      breaks = c('US', 'French'),
                      values = c('#880d1e', '#3f88c5'),
                      labels = c('US-TRS', 'French TRS')) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.text.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.title.y = element_blank(),
        axis.text.y = element_text(face='bold', size = 16, margin = margin(r=5)),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        plot.caption = element_text(hjust=0, size = 12))

```

# Figure 3: Kaplan-Meier curves by US TRS score

```{r}

data_test_temporal <- data_test_temporal |> 
  mutate(risk_group = case_when(
    US_TRS_score >= 9 ~ 0,
    US_TRS_score <= 8 & US_TRS_score >= 8 ~ 1,
    US_TRS_score <= 7 ~ 2),
    risk_group = factor(risk_group,
                        levels = c(0, 1, 2),
                        labels = c("Low risk", 
                                   "Mediumrisk",
                                   "High risk")))

us_trs_km <- surv_fit(Surv(surv_time_365, surv_status_365) ~ risk_group,
                            data = data_test_temporal,
                            stype = 1,
                            ctype = 1,
                            conf.type = "log")
  
ggsurvplot(
  us_trs_km,                 
  pval = TRUE,                     
  conf.int = TRUE,                 
  conf.int.style = "ribbon",       
  xlab = "Time since transplantation (days)", 
  ggtheme = custom_theme(),
  break.time.by = 90,
  risk.table = "absolute",         
  risk.table.height = 0.3,        
  risk.table.y.text.col = TRUE,    
  risk.table.y.text = TRUE,
  risk.table.fontsize = 6,
  font.x = c(20, "bold"),
  font.y = c(20, "bold"),
  font.tickslab = c(20, "plain"),
  font.legend = c(20, "bold"),
  ncensor.plot = FALSE,
  surv.median.line = "none", 
  legend.labs = 
    c(" Low risk", " Medium risk", " High risk"),
  legend = c(0.8, 0.25),
  legend.title = "",
  xlim = c(0, 365),             
  linetype = c("solid", "solid", "solid"), 
  ylim = c(0, 1),   
  censor = FALSE,
  palette = c('#3f88c5', '#a37c40', '#880d1e'))

```

# Figure 4: Calibration plot (observed mortality by decile of RMST)

```{r}

# Observed and predicted mortality
us_trs_pred_surv <- us_trs_predicted$survival[,365]

us_trs_pred_mort <- 1 - us_trs_pred_surv

data_test_temporal <- data_test_temporal |> cbind(us_trs_pred_mort)

# observed_mortality_by_score <- data_test_temporal |> 
#   
#   group_by(US_TRS_score) |> 
#   
#   summarise(num_deaths = sum(surv_status_365),
#             num_pts_at_score = n(),
#             mean_pred_mort = mean(us_trs_pred_mort)) |> 
#   
#   mutate(obs_mort = num_deaths /  num_pts_at_score)

observed_mortality_by_percentile <- data_test_temporal |> 
  
  group_by(US_TRS_percentile) |> 
  
  summarise(num_deaths = sum(surv_status_365),
            num_pts_at_percentile = n(),
            mean_pred_mort = mean(us_trs_pred_mort),
            obs_mort = mean(surv_status_365),
            mean_us_trs = mean(US_TRS_score),
            median_us_trs = median(US_TRS_score)) |> 
  
  mutate(sd = sqrt(obs_mort*(1-obs_mort)),
         se = sd/sqrt(num_pts_at_percentile),
         upper_ci = obs_mort + 1.96*se,
         lower_ci = obs_mort - 1.96*se)

calibration_lm <- lm(obs_mort ~ mean_pred_mort,
                     data = observed_mortality_by_percentile)

summary(calibration_lm)

observed_mortality_by_percentile |> 
  ggplot(mapping = aes(x = mean_pred_mort, y = obs_mort, color = median_us_trs)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) +
  geom_abline(slope = 1, intercept = 0, color = 'black', linetype = 2) +
  scale_color_gradient(name = 'Median US-TRS Score', low = '#880d1e', high = '#3f88c5') +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Predicted 1-year mortality risk") +
  ylab("Observed 1-year mortality") +
  xlim(0, 0.275) +
  ylim(0, 0.275)

```

# Calibration plot by mean RMST and mean survival time

```{r}
data_test_temporal <- data_test_temporal |> 
  group_by(US_TRS_score) |> 
  mutate(mean_rmst = mean(rmst_test),
         mean_surv_time = mean(surv_time_365),
         num_pts_at_score = n()) |> 
  ungroup() |> 
  set_variable_labels(
    mean_rmst = "Mean RMST (days)",
    mean_surv_time = "Mean observed survival time (days)",
    num_pts_at_score = "Number of patients",
    risk_group = "Risk group"
  )

collected_means <- data_test_temporal |> 
  select(mean_surv_time, mean_rmst, US_TRS_score) |> distinct()

collected_means |> ggplot(mapping = aes(x = US_TRS_score)) +
  geom_line(mapping = aes(y = mean_rmst, color = "Mean RMST")) +
  geom_line(mapping = aes(y = mean_surv_time, color = "Mean survival time")) +
  labs(color = "Legend")

calibration_model <- lm(mean_surv_time ~ mean_rmst, 
                        data = collected_means)

cal_model_sum <- summary(calibration_model)

data_test_temporal |> 
  ggplot(mapping = aes(x = mean_rmst, 
                       y = mean_surv_time,
                       color = risk_group,
                       size = num_pts_at_score)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = c('#3f88c5', '#a37c40', '#880d1e')) +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Mean RMST (days)") +
  ylab("Mean observed survival time (days)") +
  xlim(0, 365) +
  ylim(0, 365) +
  labs(color = "Risk group", size = "Number of recipients")
  # annotate('text', x = 325, y = 175, 
  #           label = paste0("R", "\u00B2", " = ", 
  #                          round(cal_model_sum$r.squared, digits = 2)),
  #          size = 5)
```

# Calibration plot by risk group

```{r}

data_test_temporal |> 
  ggplot(mapping = aes(x = rmst_test, 
                       y = surv_time_365,
                       color = risk_group)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  scale_color_manual(values = c('#3f88c5', '#a37c40', '#880d1e')) +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Restricted mean survival time (days)") +
  ylab("Observed survival time (days)") +
  xlim(0, 365) +
  ylim(0, 365) +
  labs(color = "Risk group", size = "Number of recipients") +
  facet_wrap(~ risk_group, nrow = 3) +
  force_panelsizes(rows = c(3, 3, 3),
                   cols = 3)

```

# US TRS by waitlist status at transplant

```{r}
data_test_temporal %>%
  mutate(curr_list_status_factor = factor(curr_list_status_factor,
                                   levels =
                                     c("Status 1",
                                       "Status 2",
                                       "Status 3",
                                       "Status 4",
                                       "Status 5",
                                       "Status 6"))) |>
  filter(!is.na(curr_list_status_factor)) %>%
  ggplot(aes(x = US_TRS_score, fill = curr_list_status_factor)) +
  scale_fill_manual(name = 'Status', values = c('#880d1e', '#a37c40', 'wheat3', '#3f88c5', 'grey', '#07090f')) +
  geom_histogram(bins = 10) +  
  xlab('US Transplant Risk Score') + ylab('Number of Recipients') +
  scale_x_continuous(breaks=c(2, 4, 6, 8, 10)) +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank()) +
  facet_wrap(~ curr_list_status_factor)
```

# Kaplan-Meier curves by waitlist status at transplant

```{r}

data_test_temporal <- data_test_temporal |> 
  mutate(curr_list_status_factor = factor(curr_list_status_factor,
                                   levels =
                                     c("Status 1",
                                       "Status 2",
                                       "Status 3",
                                       "Status 4",
                                       "Status 5",
                                       "Status 6")))

waitlist_km <- surv_fit(Surv(surv_time_365, surv_status_365) ~ curr_list_status_factor,
                            data = data_test_temporal,
                            stype = 1,
                            ctype = 1,
                            conf.type = "log")
  
ggsurvplot(
  waitlist_km,                 
  pval = TRUE,                     
  conf.int = FALSE,                 
  conf.int.style = "ribbon",       
  xlab = "Time since transplantation (days)", 
  ggtheme = custom_theme(),
  break.time.by = 90,
  risk.table = "absolute",         
  risk.table.height = 0.3,        
  risk.table.y.text.col = TRUE,    
  risk.table.y.text = TRUE,
  risk.table.fontsize = 2,
  font.x = c(14, "bold"),
  font.y = c(14, "bold"),
  font.tickslab = c(14, "plain"),
  font.legend = c(12, "bold"),
  ncensor.plot = FALSE,
  surv.median.line = "none", 
  legend.labs =
    c(" Status 1", " Status 2", " Status 3", " Status 4", " Status 5", " Status 6"),
  legend = c(0.185, 0.375),
  legend.title = "Status at transplant",
  xlim = c(0, 365),             
  linetype = c("solid", "solid", "solid", "solid", "solid", "solid"),
  ylim = c(0, 1),   
  censor = FALSE,
  palette = c('#880d1e', '#a37c40', 'wheat3', '#3f88c5', 'grey', '#07090f'))

```

# Kaplan-Meier curves by risk group, stratified by low vs. high risk donors

```{r}
data_test_temporal <- data_test_temporal |> 
  mutate(
    
    high_risk_donor = case_when(donor_sex == 1 & donor_age_over_55 == 1 ~ 1,
                                 donor_age_over_55 == 1 & PHM_ratio_undersized == 1 ~ 1,
                                 PHM_ratio_undersized == 1 & donor_sex == 1 ~ 1,
                                 TRUE ~ 0),
    
    risk_group_by_donor = case_when(
    risk_group == "Low risk" & high_risk_donor == 0 ~ 0,
    risk_group == "Low risk" & high_risk_donor == 1 ~ 1,
    risk_group == "Medium risk" & high_risk_donor == 0 ~ 2,
    risk_group == "Medium risk" & high_risk_donor == 1 ~ 3,
    risk_group == "High risk" & high_risk_donor == 0 ~ 2,
    risk_group == "High risk" & high_risk_donor == 1 ~ 3),
    risk_group_by_donor = factor(risk_group_by_donor,
                        levels = c(0, 1, 2, 3),
                        labels = c("Low risk recipients, low risk donors", 
                                   "Low risk recipients, high risk donors",
                                   "Medium/high risk recipients, low risk donors",
                                   "Medium/high risk recipients, high risk donors")))

us_trs_km_by_donor <- surv_fit(Surv(surv_time_365, surv_status_365) ~ risk_group_by_donor,
                            data = data_test_temporal,
                            stype = 1,
                            ctype = 1,
                            conf.type = "log")
  
ggsurvplot(
  us_trs_km_by_donor,                 
  pval = FALSE,                     
  conf.int = FALSE,                 
  conf.int.style = "ribbon",       
  xlab = "Time since transplantation (days)", 
  ggtheme = custom_theme(),
  break.time.by = 90,
  risk.table = "absolute",         
  risk.table.height = 0.3,        
  risk.table.y.text.col = TRUE,    
  risk.table.y.text = FALSE,
  risk.table.fontsize = 6,
  font.x = c(14, "bold"),
  font.y = c(14, "bold"),
  font.tickslab = c(14, "plain"),
  font.legend = c(16, "bold"),
  ncensor.plot = FALSE,
  surv.median.line = "none", 
  legend.labs = 
    c(" Low risk recipients, low risk donors",
      " Low risk recipients, high risk donors", 
      " Medium/high risk recipients, low risk donors",
      " Medium/high risk recipients, high risk donors"),
  legend = c(0.6, 0.25),
  legend.title = "",
  xlim = c(0, 365),             
  linetype = c("solid", 
               "dashed", 
               "solid", 
               "dashed"), 
  ylim = c(0, 1),   
  censor = FALSE,
  palette = c('#3f88c5',
              '#3f88c4',
              '#880d1e',
              '#880d1d'))
```

# Forest plot of US-TRS predictors alone

```{r, warning=F, echo=F, message=F, comment=NA, fig.align='center', fig.height=8, fig.width=8}

# Collecting US-TRS estimates and CIs
df_coefplot <- as.data.frame(summary(us_trs)$conf.int)[,c(1,3,4)]
df_coefplot$variable <- rownames(df_coefplot)
rownames(df_coefplot) <- NULL
colnames(df_coefplot) <- c('estimate', 'lower_CI', 'upper_CI', 'variable')
df_coefplot <- df_coefplot |> filter(variable != "frailty(center_id)")

df_coefplot$variable <- c('Recipient age', 'Indication: CHD', 
                          'Diabetes', 'Mechanical ventilation', 
                          'Durable LVAD',
                          'eGFR', 'Log bilirubin', 'Albumin',
                          'Donor age over 55', 'Female donor', 'Size mismatch')

df_coefplot[nrow(df_coefplot) + 1,] = c(NA, NA, NA, "History of cardiac surgery")

df_coefplot <- df_coefplot |> 
  mutate(estimate = as.numeric(estimate),
         lower_CI = as.numeric(lower_CI),
         upper_CI = as.numeric(upper_CI))

df_coefplot %>%
  ggplot(aes(x=estimate, 
             y=factor(variable, 
                      levels = c('Size mismatch', 'Female donor', 
                                 'Donor age over 55',
                                 'Indication: CHD', 'Durable LVAD', 
                                 'Mechanical ventilation',
                                 'Diabetes',
                                 'Albumin', 
                                 'eGFR', 'Log bilirubin',
                                 'Recipient age')))) +
             # color=model)) +
  geom_point(size = 3.25, position = position_dodge(width = 0.7)) +
  geom_errorbarh(aes(xmin = lower_CI, xmax = upper_CI), position = position_dodge(width = 0.7)) +
  geom_vline(xintercept = 1, lty = 2, color = '#880d1e', linewidth = 0.05) +
  xlab('Hazard Ratio (95% CI)') + xlim(0, 5) +
  labs(caption = paste0("\u1D43", "Variable scaled by factor of 10")) +
  scale_y_discrete(labels=c('Size mismatch (D:R PHM ratio < 0.86)',
                            'Female donor',
                            'Donor age over 55',
                            'Indication: Congenital heart disease',
                            'Durable LVAD',
                            'Mechanical ventilation',
                            'Diabetes',
                            'Albumin',
                            expression('eGFR'^'a'),
                            'Log bilirubin',
                            expression('Recipient age (yrs)'^'a'))) +
  scale_x_log10(n.breaks = 6) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.text.x = element_text(face='bold', size = 16, margin = margin(t=5)), 
        axis.title.y = element_blank(),
        axis.text.y = element_text(face='bold', size = 16, margin = margin(r=5)),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        plot.caption = element_text(hjust=0, size = 12))
```

# C-index from US TRS model over time

```{r}

ctemp <- matrix(0, 354, 2) # concordance and std err
ctemp_impact <- matrix(0, 354, 2) # concordance and std err
ctemp_impact_score <- matrix(0, 354, 2) # concordance and std err
ctemp_waitlist_status <- matrix(0, 354, 2) # concordance and std err

ctime <- seq(7, 365, length=354)

for (i in 1:354) {
  temp <- concordance(us_trs, newdata = data_test_temporal, ymax=ctime[i], timewt="n/G2")
  ctemp[i,] <- c(temp$concordance, sqrt(temp$var))
  
  temp_impact <- concordance(impact_cox, newdata = data_test_temporal, ymax=ctime[i], timewt="n/G2")
  ctemp_impact[i,] <- c(temp_impact$concordance, sqrt(temp_impact$var))
  
  temp_impact_score <- concordance(impact_score_cox, newdata = data_test_temporal, ymax=ctime[i], timewt="n/G2")
  ctemp_impact_score[i,] <- c(temp_impact_score$concordance, sqrt(temp_impact_score$var))
  
  temp_waitlist_status <- concordance(waitlist_status_cox, newdata = data_test_temporal, ymax=ctime[i], timewt="n/G2")
  ctemp_waitlist_status[i,] <- c(temp_waitlist_status$concordance, sqrt(temp_waitlist_status$var))
}

yhat <- ctemp[,1] + outer(ctemp[,2], c(0, -1.96, 1.96), '*')
yhat_impact <- ctemp_impact[,1] + outer(ctemp_impact[,2], c(0, -1.96, 1.96), '*')
yhat_impact_score <- ctemp_impact_score[,1] + outer(ctemp_impact_score[,2], c(0, -1.96, 1.96), '*')
yhat_waitlist_status <- ctemp_waitlist_status[,1] + outer(ctemp_waitlist_status[,2], c(0, -1.96, 1.96), '*')

ctemp_moving_avg <- rollmean(ctemp[,1], 7)
ctemp_impact_moving_avg <- rollmean(ctemp_impact[,1], 7)
ctemp_impact_score_moving_avg <- rollmean(ctemp_impact_score[,1], 7)
ctemp_waitlist_status_moving_avg <- rollmean(ctemp_waitlist_status[,1], 7)

(atc_figure <- ggplot() +
    
  # geom_line(aes(x = ctime[4:357], y = ctemp_impact_moving_avg, color = "IMPACT Predictors"), linewidth = 1) +
  geom_line(aes(x = ctime[4:351], y = ctemp_impact_score_moving_avg, color = "IMPACT Score"), linewidth = 2) +
  geom_line(aes(x = ctime[4:351], y = ctemp_waitlist_status_moving_avg, color = "Waitlist Status at Transplant"), linewidth = 2) +
  geom_line(aes(x = ctime[4:351], y = ctemp_moving_avg, color = "US-TRS Model"), linewidth = 2) +
    
  # geom_line(aes(x = ctime, y = ctemp_impact[,1], color = "IMPACT Predictors"), linewidth = 1) +
  # geom_line(aes(x = ctime, y = ctemp_impact_score[,1], color = "IMPACT Score"), linewidth = 1) +
  # geom_line(aes(x = ctime, y = ctemp_waitlist_status[,1], color = "Waitlist Status at Transplant"), linewidth = 1) +
  # geom_line(aes(x = ctime, y = ctemp[,1], color = "US-TRS Model"), linewidth = 1) +
  
  # ylim(0.45, 1) +
  scale_y_continuous(breaks=seq(0.5, 1, 0.1), limits=c(0.5,1)) +
  scale_x_continuous(breaks=seq(0,360,90)) +
  labs(x = "Time from transplant date (days)",
       y = "Concordance index",
         color = "Legend") +
   scale_color_manual(name = 'Model', values = c('#a37c40', '#07090f', '#880d1e'),
                      breaks = c("US-TRS Model", "IMPACT Score", "Waitlist Status at Transplant")) +
    theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 20, margin = margin(t=5)), 
    axis.text.x = element_text(size = 20, margin = margin(t=5)), 
    axis.title.y = element_text(size = 20, margin = margin(r=5)),
    axis.text.y = element_text(size = 20, margin = margin(r=5)),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 20),
    legend.position = c(0.65, 0.75),
    strip.text = element_text(size = 20, face = 'bold', color = 'black'),
    strip.background = element_blank()))
```

# Test for sufficiency by sex and race/ethnicity

```{r}

# Female recipients
observed_mortality_by_percentile_female <- data_test_temporal |> 
  
  filter(cand_sex_factor == "Female") |> 
  
  group_by(US_TRS_percentile) |> 
  
  summarise(num_deaths = sum(surv_status_365),
            num_pts_at_percentile = n(),
            mean_pred_mort = mean(us_trs_pred_mort),
            obs_mort = mean(surv_status_365),
            mean_us_trs = mean(US_TRS_score),
            median_us_trs = median(US_TRS_score)) |> 
  
  mutate(sd = sqrt(obs_mort*(1-obs_mort)),
         se = sd/sqrt(num_pts_at_percentile),
         upper_ci = obs_mort + 1.96*se,
         lower_ci = obs_mort - 1.96*se)

calibration_lm_female <- lm(obs_mort ~ mean_pred_mort,
                     data = observed_mortality_by_percentile_female)

summary(calibration_lm_female)

female_calibration <- observed_mortality_by_percentile_female |> 
  ggplot(mapping = aes(x = mean_pred_mort, y = obs_mort, color = median_us_trs)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) +
  geom_abline(slope = 1, intercept = 0, color = 'black', linetype = 2) +
  scale_color_gradient(name = 'Median US-TRS Score', low = '#880d1e', high = '#3f88c5') +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Predicted 1-year mortality risk") +
  ylab("Observed 1-year mortality") +
  labs(title = "Female recipients") +
  xlim(-0.025, 0.35) +
  ylim(-0.025, 0.35)

# Male recipients
observed_mortality_by_percentile_male <- data_test_temporal |> 
  
  filter(cand_sex_factor == "Male") |> 
  
  group_by(US_TRS_percentile) |> 
  
  summarise(num_deaths = sum(surv_status_365),
            num_pts_at_percentile = n(),
            mean_pred_mort = mean(us_trs_pred_mort),
            obs_mort = mean(surv_status_365),
            mean_us_trs = mean(US_TRS_score),
            median_us_trs = median(US_TRS_score)) |> 
  
  mutate(sd = sqrt(obs_mort*(1-obs_mort)),
         se = sd/sqrt(num_pts_at_percentile),
         upper_ci = obs_mort + 1.96*se,
         lower_ci = obs_mort - 1.96*se)

calibration_lm_male <- lm(obs_mort ~ mean_pred_mort,
                     data = observed_mortality_by_percentile_male)

summary(calibration_lm_male)

male_calibration <- observed_mortality_by_percentile_male |> 
  ggplot(mapping = aes(x = mean_pred_mort, y = obs_mort, color = median_us_trs)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) +
  geom_abline(slope = 1, intercept = 0, color = 'black', linetype = 2) +
  scale_color_gradient(name = 'Median US-TRS Score', low = '#880d1e', high = '#3f88c5') +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Predicted 1-year mortality risk") +
  ylab("Observed 1-year mortality") +
  labs(title = "Male recipients") +
  xlim(-0.025, 0.35) +
  ylim(-0.025, 0.35)

# White recipients
observed_mortality_by_percentile_white <- data_test_temporal |> 
  
  filter(race == "White") |> 
  
  group_by(US_TRS_percentile) |> 
  
  summarise(num_deaths = sum(surv_status_365),
            num_pts_at_percentile = n(),
            mean_pred_mort = mean(us_trs_pred_mort),
            obs_mort = mean(surv_status_365),
            mean_us_trs = mean(US_TRS_score),
            median_us_trs = median(US_TRS_score)) |> 
  
  mutate(sd = sqrt(obs_mort*(1-obs_mort)),
         se = sd/sqrt(num_pts_at_percentile),
         upper_ci = obs_mort + 1.96*se,
         lower_ci = obs_mort - 1.96*se)

calibration_lm_white <- lm(obs_mort ~ mean_pred_mort,
                     data = observed_mortality_by_percentile_white)

summary(calibration_lm_white)

white_calibration <- observed_mortality_by_percentile_white |> 
  ggplot(mapping = aes(x = mean_pred_mort, y = obs_mort, color = median_us_trs)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) +
  geom_abline(slope = 1, intercept = 0, color = 'black', linetype = 2) +
  scale_color_gradient(name = 'Median US-TRS Score', low = '#880d1e', high = '#3f88c5') +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Predicted 1-year mortality risk") +
  ylab("Observed 1-year mortality") +
  labs(title = "White recipients") +
  xlim(-0.025, 0.35) +
  ylim(-0.025, 0.35)

# Non-white recipients
observed_mortality_by_percentile_non_white <- data_test_temporal |> 
  
  filter(race != "White") |> 
  
  group_by(US_TRS_percentile) |> 
  
  summarise(num_deaths = sum(surv_status_365),
            num_pts_at_percentile = n(),
            mean_pred_mort = mean(us_trs_pred_mort),
            obs_mort = mean(surv_status_365),
            mean_us_trs = mean(US_TRS_score),
            median_us_trs = median(US_TRS_score)) |> 
  
  mutate(sd = sqrt(obs_mort*(1-obs_mort)),
         se = sd/sqrt(num_pts_at_percentile),
         upper_ci = obs_mort + 1.96*se,
         lower_ci = obs_mort - 1.96*se)

calibration_lm_non_white <- lm(obs_mort ~ mean_pred_mort,
                     data = observed_mortality_by_percentile_non_white)

summary(calibration_lm_non_white)

non_white_calibration <- observed_mortality_by_percentile_non_white |> 
  ggplot(mapping = aes(x = mean_pred_mort, y = obs_mort, color = median_us_trs)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) +
  geom_abline(slope = 1, intercept = 0, color = 'black', linetype = 2) +
  scale_color_gradient(name = 'Median US-TRS Score', low = '#880d1e', high = '#3f88c5') +
  theme_bw() + 
    theme(
    panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
    axis.title.x = element_text(size = 15, margin = margin(t=5)), 
    axis.text.x = element_text(size = 15, margin = margin(t=5)), 
    axis.title.y = element_text(size = 15, margin = margin(r=5)),
    axis.text.y = element_text(size = 14, margin = margin(r=5)),
    legend.title = element_text(size = 15),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16, face = 'bold', color = 'black'),
    strip.background = element_blank())   +
  xlab("Predicted 1-year mortality risk") +
  ylab("Observed 1-year mortality") +
  labs(title = "Non-White recipients") +
  xlim(-0.025, 0.35) +
  ylim(-0.025, 0.35)

cowplot::plot_grid(female_calibration, 
                   male_calibration,
                   white_calibration,
                   non_white_calibration, ncol=2, labels='auto', scale=0.9)

```

# STROBE flow diagram

```{r}

# options(txt_gp = gpar(cex = 0.8))
# 
# txt0 <- "12,274 U.S. heart transplant recipients, October 2018 - February 2022"
# txt1 <- "9,069 adult heart transplant recipients"
# txt1_side <- "3,192 recipients excluded:\n\u2022 Listed prior to 2018 policy change (n=1,722)\n\u2022 Age < 18 at listing (n=1,462)\n\u2022 Data entry error (n=21)"
# 
# flow_diagram <- add_box(txt = txt0) |>
#   add_side_box(txt = txt1_side) |> 
#   add_box(txt = txt1) |>
#   add_split(txt = c("Training set (n=6,348)\n\u2022 Transplanted from October 23, 2018 - April 17, 2021\n\u2022 570 events within 1 year of transplant (9.0%)", "Testing set (n=2,721)\n\u2022 Transplanted from April 17, 2021 - February 28, 2022\n\u2022 252 events within 1 year of transplant (9.3%)"))
# 
# plot(flow_diagram)

```

# Table 1: Summary table

```{r}

train_temporal_PX_IDs <- data_train_temporal |> pull(PX_ID)

final_list_at_tx <- final_list_at_tx |> 
  mutate(which_set = if_else(PX_ID %in% train_temporal_PX_IDs, 0, 1), 
         which_set_factor = factor(which_set,
                                   levels = c(0, 1),
                                   labels = c("Training set", "Testing set")))

final_list_at_tx <- final_list_at_tx |> set_variable_labels(
  surv_status_365_factor = "Survival status at 1 year",
  durable_LVAD = "Durable LVAD",
  donor_sex_factor = "Donor sex",
  diabetes_factor = "History of diabetes",
  cand_sex_factor = "Recipient sex",
  diagnosis_factor = "Indication for transplant",
  mech_vent_factor = "Mechanical ventilation",
  mech_vent = "Mechanical ventilation",
  race = "Race",
  rec_age = "Recipient age at transplant (yrs)",
  eGFR = "eGFR",
  bilirubin = "Total bilirubin",
  albumin = "Serum albumin",
  donor_age = "Donor age (yrs)",
  PHM_rec = "Recipient predicted heart mass",
  PHM_don = "Donor predicted heart mass",
  hx_card_surg = "History of cardiac surgery",
  IMPACT_score = "IMPACT score",
  curr_list_status_factor = "Waitlist status at transplant",
  ethnicity = "Ethnicity")

summary_table <- final_list_at_tx |> select(
  
  rec_age,
  cand_sex_factor,
  race,
  diagnosis_factor,
  curr_list_status_factor,
  hx_card_surg,
  diabetes,
  infection,
  dialysis,
  PHM_rec,
  mech_vent,
  short_MCS_ever,
  durable_LVAD,
  eGFR,
  bilirubin,
  albumin,
  donor_age,
  donor_sex_factor,
  PHM_don,
  ethnicity,
  which_set_factor) |> 
  
  mutate(curr_list_status_factor = factor(curr_list_status_factor,
                                   levels =
                                     c("Status 1",
                                       "Status 2",
                                       "Status 3",
                                       "Status 4",
                                       "Status 5",
                                       "Status 6"))) |>
  filter(!is.na(curr_list_status_factor)) |> 
  
  set_variable_labels(curr_list_status_factor = "Waitlist status at transplant") |> 
  
  tbl_summary(by = which_set_factor,
              statistic = list(
                albumin ~ "{mean} ({sd})",
                eGFR ~ "{mean} ({sd})",
                PHM_rec ~ "{mean} ({sd})",
                PHM_don ~ "{mean} ({sd})")) |> 
  add_p()

summary_table

summary_table |> 
  as_gt() |> 
  gtsave(
    filename = "us_trs_table1.rtf")

```

# Summary table not split into training and test sets

```{r}

final_list_at_tx |> select(
  
  rec_age,
  cand_sex_factor,
  race,
  waitlist_time,
  diagnosis_factor,
  curr_list_status_factor,
  surv_status_365_factor,
  diabetes_factor,
  infection,
  dialysis,
  mech_vent_factor,
  short_MCS_ever,
  durable_LVAD,
  eGFR,
  log_bilirubin,
  albumin,
  donor_age,
  donor_sex_factor,
  PHM_rec,
  PHM_don,
  hx_card_surg,
  which_set_factor, 
  ethnicity,
  PX_ID) |> 
  
  mutate(curr_list_status_factor = factor(curr_list_status_factor,
                                   levels =
                                     c("Status 1",
                                       "Status 2",
                                       "Status 3",
                                       "Status 4",
                                       "Status 5",
                                       "Status 6"))) |>
  filter(!is.na(curr_list_status_factor)) |> 
  
  set_variable_labels(curr_list_status_factor = "Waitlist status at transplant") |> 
  
  left_join(tx_hr |> select(PERS_ID, PX_ID), by = "PX_ID") |> 
  
  distinct(PERS_ID, .keep_all = TRUE) |> 
  
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})",
                               waitlist_time ~ "{median} ({p25}, {p75})"))

```

# Examining number of unique recipients and retransplants

```{r}
tx_hr |> 
  filter(!is.na(PERS_RETX)) |> 
  select(PX_ID, PERS_ID, REC_TX_DT, PERS_RELIST, PERS_RETX, TFL_LASTATUS) |>
  mutate(difference = PERS_RETX - REC_TX_DT) |> 
  filter(difference <= 365) |> 
  left_join(final_list_at_tx |> 
              select(surv_time_365, surv_status_365, last_status, PX_ID), 
            by = "PX_ID") |> 
  mutate(training_set = if_else(REC_TX_DT < testing_start_date, 1, 0))

double_PERS_IDs <- tx_hr |> 
  select(PERS_ID) |> 
  group_by(PERS_ID) |> 
  count(sort = TRUE) |>
  filter(n == 2) |> 
  select(PERS_ID)

retx_PERS_IDs <- tx_hr |> 
  filter(!is.na(PERS_RETX)) |> 
  mutate(difference = PERS_RETX - REC_TX_DT) |> 
  filter(difference <= 365) |> 
  select(PERS_ID)

not_captured <- double_PERS_IDs |> 
  filter(!(PERS_ID %in% retx_PERS_IDs$PERS_ID))

not_captured

```
